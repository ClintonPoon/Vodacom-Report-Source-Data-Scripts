SELECT 
    PREP.PCO_OUTBOUNDSERVICE.ID,
    PREP.PCO_OUTBOUNDSERVICE.TYPE,
    PREP.PCO_OUTBOUNDSERVICE.NAME,
    PREP.PCO_OUTBOUNDSERVICE.STATUS,
    PREP.PCO_OUTBOUNDSERVICE.PREVIEWVDN,
    PREP.PCO_OUTBOUNDSERVICE.CALLERID,
    Convert(Date, PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) AS [Start Date],
	DATEPART(HOUR,PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) AS [Hour], 
    SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) AS [Total Dials],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.LIVECONTACTS) AS [Total Live Contacts],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.ANSWERED) AS [Total Answered],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.CONNECTED) AS [Total Connected],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL) AS [Total Useful],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.POSITIVEUSEFUL) AS [Total Sales],

	-----------------Calculations---------------------------------

CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.LIVECONTACTS)/SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) END AS [Connect Rate],

CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL)/SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) END AS [RPC Rate],

CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.POSITIVEUSEFUL)/SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL) END AS [RPC to Sale Conversion  Rate],

CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.POSITIVEUSEFUL)/SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) END AS [Sale Conversion Rate]


FROM PREP.PCO_OUTBOUNDSERVICE
LEFT JOIN PREP.PSTAT_SERVICEHALFHOUR 
    ON PREP.PSTAT_SERVICEHALFHOUR.SERVICEID = PREP.PCO_OUTBOUNDSERVICE.ID
WHERE YEAR(PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) = YEAR(GETDATE()) and
MONTH(PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) = MONTH(GETDATE()) and
DAY(PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) = DAY(GETDATE())

GROUP BY
    PREP.PCO_OUTBOUNDSERVICE.ID,
    PREP.PCO_OUTBOUNDSERVICE.TYPE,
    PREP.PCO_OUTBOUNDSERVICE.NAME,
    PREP.PCO_OUTBOUNDSERVICE.STATUS,
    PREP.PCO_OUTBOUNDSERVICE.PREVIEWVDN,
    PREP.PCO_OUTBOUNDSERVICE.CALLERID,
    Convert(Date, PREP.PSTAT_SERVICEHALFHOUR.STARTDATE),
	DATEPART(HOUR,PREP.PSTAT_SERVICEHALFHOUR.STARTDATE)
ORDER BY [Start Date] DESC
