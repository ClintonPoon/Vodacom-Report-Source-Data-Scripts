SELECT 
    PREP.PCO_OUTBOUNDSERVICE.ID,
    CASE 
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID >= 1001 AND PREP.PCO_OUTBOUNDSERVICE.ID <= 1138 THEN 'Telkom Mobile'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1139 THEN 'Telkom Prepaid Fibre'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1140 THEN 'Telkom Mobile'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 2 THEN 'Vasco Manual ACD'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1200 THEN 'Vodacom OOC'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1310 THEN 'Vodacom OOC'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1302 THEN 'Vodacom AOL'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1303 THEN 'Vodacom Migration'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1300 THEN 'Vodacom FTTH'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1308 THEN 'Vodacom FTTH'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1309 THEN 'Vodacom FTTH HomeInternet'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1203 THEN 'Vodacom Online'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1204 THEN 'Vodacom Online'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1207 THEN 'Vodacom OOC Learnership'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1208 THEN 'Vodacom AOL Learnership'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1500 THEN 'Vodacom EBU'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID >= 1416 AND PREP.PCO_OUTBOUNDSERVICE.ID <= 1418 THEN 'Vodacom Upgrades'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1401 THEN 'MTN Fibre'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1409 THEN 'MTN Support'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID >= 1411 AND PREP.PCO_OUTBOUNDSERVICE.ID <= 1415 THEN 'MTN Fibre'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID >= 1407 AND PREP.PCO_OUTBOUNDSERVICE.ID <= 1408 THEN 'MTN Fibre'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1410 THEN 'MTN Fibre'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID = 1400 THEN 'MTN Online'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID >= 1402 AND PREP.PCO_OUTBOUNDSERVICE.ID <= 1406 THEN 'MTN Online'
        WHEN PREP.PCO_OUTBOUNDSERVICE.ID >= 2100 AND PREP.PCO_OUTBOUNDSERVICE.ID <= 2199 THEN 'UCR Energy'
        ELSE CAST(PREP.PCO_OUTBOUNDSERVICE.ID AS VARCHAR(50))
    END AS [Campaign Name],

    PREP.PCO_OUTBOUNDSERVICE.TYPE,
    PREP.PCO_OUTBOUNDSERVICE.NAME,
    PREP.PCO_OUTBOUNDSERVICE.STATUS,
    PREP.PCO_OUTBOUNDSERVICE.PREVIEWVDN,
    PREP.PCO_OUTBOUNDSERVICE.CALLERID,
    Convert(Date, PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) AS [Start Date],
    DATEPART(HOUR,PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) AS [Hour], 
    DATENAME(MONTH, PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) AS [Month],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) AS [Total Dials],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.LIVECONTACTS) AS [Total Live Contacts],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.ANSWERED) AS [Total Answered],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.CONNECTED) AS [Total Connected],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL) AS [Total Useful],
    SUM(PREP.PSTAT_SERVICEHALFHOUR.POSITIVEUSEFUL) AS [Total Sales],

    -----------------Calculations---------------------------------

    CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.LIVECONTACTS)/SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) END AS [Connect Rate],
    CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL)/SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) END AS [RPC Rate],
    CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.POSITIVEUSEFUL)/SUM(PREP.PSTAT_SERVICEHALFHOUR.USEFUL) END AS [RPC to Sale Conversion Rate],
    CASE WHEN SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) = 0 THEN 0 ELSE SUM(PREP.PSTAT_SERVICEHALFHOUR.POSITIVEUSEFUL)/SUM(PREP.PSTAT_SERVICEHALFHOUR.CONTACTS) END AS [Sale Conversion Rate]

FROM PREP.PCO_OUTBOUNDSERVICE
LEFT JOIN PREP.PSTAT_SERVICEHALFHOUR 
    ON PREP.PSTAT_SERVICEHALFHOUR.SERVICEID = PREP.PCO_OUTBOUNDSERVICE.ID
WHERE YEAR(PREP.PSTAT_SERVICEHALFHOUR.STARTDATE) = YEAR(GETDATE())

GROUP BY
    PREP.PCO_OUTBOUNDSERVICE.ID,
    PREP.PCO_OUTBOUNDSERVICE.TYPE,
    PREP.PCO_OUTBOUNDSERVICE.NAME,
    PREP.PCO_OUTBOUNDSERVICE.STATUS,
    PREP.PCO_OUTBOUNDSERVICE.PREVIEWVDN,
    PREP.PCO_OUTBOUNDSERVICE.CALLERID,
    Convert(Date, PREP.PSTAT_SERVICEHALFHOUR.STARTDATE),
    DATEPART(HOUR,PREP.PSTAT_SERVICEHALFHOUR.STARTDATE),
    DATENAME(MONTH, PREP.PSTAT_SERVICEHALFHOUR.STARTDATE)
ORDER BY [Start Date] DESC;
